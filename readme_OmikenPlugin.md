# おみくじBOTプラグイン OmikenPlugin for わんコメ v0.0.10

最終更新日：2024/12/23

配信者のためのコメントアプリ「わんコメ」で使用できる、プラグイン です。

## このコードを利用するときは

- わんコメ(https://onecomme.com/) の利用規約に基づきます。
- わんコメの利用規約に基づき、コードに限っては商業利用も含め自由に利用することができます。
- 本コードの使用に伴ういかなる損害についても責任を負いません。ご利用は自己責任でお願いします。
- ベータ版のため、動作保証はありません。コードや仕様は予告なく変更される可能性があります。

## このテンプレートは何？

### ここに見出し

- 内容とか

### 「初見ありがとう」から「久しぶり」まで。多種多様な挨拶してくれる!

#### はじめまして！がわかる「初見判定機能」

![初見さん、いらっしゃい！](readme_image/240824_01.jpg)

- わんコメのデータを参照し、**初見さんには「初見ありがとう!」を、久々の方には「久しぶり!」を、その日初めての方には「ようこそ!」の挨拶**をしてくれる BOT です。
- 「初見詐欺」を見破る機能も搭載しており（ON/OFF 可能）、配信者の代わりに BOT が叱ってくれます。

#### チャンネル登録お願い！「告知タイマー機能」

![チャンネル登録、高評価お願いね](readme_image/240824_02.jpg)

- 定期的に視聴者へお知らせを表示するタイマー機能を搭載しています。
- キャラクターなどを扱っている場合、ちょっとした小言を話させるのも面白いかもしれません。

#### ギフト・スーパーチャットへのお礼「ギフト返信機能」

![ギフトのお礼もできます](readme_image/240824_03.jpg)

- ギフトやスーパーチャットに対し、自動でお礼のメッセージを送信します。
- 金額に応じて返信内容をカスタマイズ可能です。

#### 参加希望者への歓迎メッセージとリスト表示

![参加リストが自動表示](readme_image/240824_04.jpg)

- 「参加型管理」機能と連動し、参加登録者に「参加ありがとう」のメッセージを自動送信します。
- 参加希望を出されたリスナーに対し、自動で歓迎メッセージや演出を送信します。
- 参加者リストが更新されると、画面内にリストが自動表示されます。

#### あなたは 100 回目のコメント「キリ番機能・総コメント集計機能」

- その配信ごとにキリのいい回数だとお祝いしてくれます。
- 個人の総コメント数が一定数超えた際にお祝いもできます

#### 小～中規模配信者向け：同時接続数 5 ～ 200 人程度に最適

- 少人数でも賑やかな雰囲気を演出！視聴者参加型の「おみくじ機能」搭載
- 視聴者が多いほどコメントが流れやすくなるため、同時接続数が多い配信には適していない可能性があります。

### コメントで反応する！カスタマイズ可能な充実の「おみくじ機能」

![「おみくじ」でランダムにおみくじが引ける](readme_image/240824_05.jpg)

#### 多彩なおみくじ機能で視聴者を楽しませる

- チャット欄に「おみくじ」や「じゃんけん」とコメントすることで、BOT が即座に反応し、視聴者の期待に応える面白い返事を返します。
- コマンドや文面、機能の ON/OFF は自由にカスタマイズ可能。配信者の個性やチャンネルの雰囲気に合わせたユニークな反応を設定できます。

#### おみくじ結果で競い合える!「ランキング表示機能」

- 「じゃんけん」「スロット」「スイカゲーム」にはランキング機能が搭載されており、リスナー全員で得点を競えます。
- ランキングリストは移動が可能で（OBS 使用時は対話モードを使用）、ダブルクリックで固定表示もできます。朝活のお供にどうぞ。

#### プリセットで入っているおみくじ機能

- **おみくじ**（おみくじ、omikuji）
  - 大吉・吉・中吉・小吉・末吉・凶の 6 種類+α。今後の方針がわかるかも？
- **じゃんけん**（じゃんけん、グー、チョキ、パー）
  - 勝率 5%!? JavaScript 本田さんはじゃんけんが強い!
- **ボンバースロット**（スロット、slot）
  - 1000 枚配当も!? 数字で楽しいスロット風おみくじ
- **合成大西瓜(スイカゲーム)**（スイカ、suika）
  - 大人気ゲーム風おみくじ!5000 点超えも夢じゃない！？

#### カスタマイズで独自の機能を追加できる!

- JavaScript を使用しているため、プログラミングの知識があれば高度なカスタマイズが可能です。
- 単純なランダム選択だけでなく、引数の取得やリスナーの投稿コメント数に応じて異なる結果を返すような仕組みも実装可能です。

## 導入方法

### わんコメにこのジェネレーターを追加する

![ジェネレーターを追加する](readme_image/02.jpg)

1. 初見判定ちゃん FirstCounter https://booth.pm/ja/items/5471598 をダウンロード
2. わんコメの右上【…】（三点リーダー）から「テンプレート」を選択
3. ファイルアイコンをクリックし、ダウンロードした zip ファイル（解凍不要）を選択

### このジェネレーターを OBS に追加する

![OBSにテンプレートを追加](readme_image/04.png)

1. わんコメの右上【…】から「テンプレート」を選択
2. 「カスタム」タブから、このジェネレーターを見つける。
3. 「ここをドラッグして OBS に入れる」の指示に従い、テンプレートを OBS のソースに追加

### 【重要】OBS の設定・プロパティを変更する

#### テンプレートの名称変更:

- 追加したテンプレート「index.html」という名称を、わかりやすい名前（例：FirstCounter 等）に変更。

#### テンプレートのプロパティを編集

![プロパティから、幅・高さを編集](readme_image/05.png)

- このジェネレーターのソースを右クリックし、「プロパティ」を選択
- 「幅」「高さ」については、そのままで使用できます。
  - 表示サイズの調整が必要な場合は、適時拡大縮小するなどで調整して下さい。
- プロパティから以下の設定を行います
  - **「表示されていないときにソースをシャットダウンする」**にチェックを入れる。

#### 【注意】これら設定をしていないと、以下のような不具合が発生する可能性があります

- タイマーやおみくじが二重三重に出てくる
- 非表示にしているのにコメントが表示される

## アップデート方法

1. ダウンロードした最新ファイルを解凍する
2. わんコメの右上にある【…】（三点リーダー）をクリックし、**「フォルダを開く > テンプレートフォルダ」**を選択
3. 表示されたフォルダから「templates」フォルダを選択
4. 「templates」フォルダ内の「FirstCounter07」フォルダを開き、解凍した「index.html」ファイルと「script」フォルダを上書き保存

注意: 「script」フォルダ内にカスタムしたファイルがある場合は、上書き前に必ずバックアップを取っておくことをおすすめします。

## 使い方・カスタマイズ

![Visual Studio Code で編集中…](readme_image/08.png)

- 基本的にはそのまま使用可能です。
- カスタマイズするには、「FirstCounter」に入っている、「custom」フォルダ内のファイルを メモ帳等で編集してください。
- カスタマイズには JavaScript の基本的な知識が必要です。（今後 GUI で編集できるようアップデートする予定です）
- わからない部分がある場合、ChatGPT や Claude などの生成 AI を活用してみてください。

### USER_CONFIG.js

#### PREFERENCES:基本設定

- isShowCounter: 初見カウンターを表示するか。true にすると、右下に初見カウンターが表示されます。(common_VisitCounter.css で位置などを変更できます)試験的に設置しています。
- isProfileImage:キャラクターのアイコンを表示するか
- basicDelay: BOT の反応遅延時間（秒）
- omikujiCooldown: おみくじ機能のクールダウン時間（秒）この時間内におみくじ判定が被ると「もう一度コメントしてね」という旨のトースト表示が出ます。
- commentValidDuration: コメントしてからおみくじを有効とする時間(秒) おみくじが反応しない場合、この時間を長めにしてみてください。
- BotUserIDname: このスクリプトが発言する comment.data.userId(通常は変更不要です)

#### CHARACTER:キャラクター設定

任意の数のキャラクターを追加できます。
おみくじ機能は、後述するキー名と一致する設定に基づいて動作します。
「config-」と付いた設定ファイルの「botKey」で使用します。

- name: BOT の名前
- frameId
  - わんコメで複数の枠を設定している場合、ID を入れることで任意の枠に投稿が可能です。
  - BOT の音声を変更する際に使用します。
- '--lcv-name-color': フキダシの名前色
- '--lcv-text-color': フキダシのテキスト色
- '--lcv-background-color': フキダシの背景色

#### CHARACTER_IMAGE:キャラクター画像

FirstCounter > img フォルダから画像を探します。
Default キーは必ず設定して下さい。
「config-」と付いた設定ファイルの「iconKey」で使用します。

#### WordParty 用効果音

別で配布(https://pintocuru.booth.pm/items/6048048)している、わんコメの WordParty 機能で使える効果音のプリセットです。
「config-」と付いた設定ファイルの「party」で使用します。
単なるコメントであり、削除しても問題ありません。

#### SYOKEN_SWITCH:初見判定ちゃん設定

初見判定に関する様々な機能のオンオフや設定を行います。
これらの機能は、common_app.js というファイルと連携して動作します。そのため、キー名は変更せずに使用してください。

switch:各機能の ON/OFF を制御、または何らかの時間を指定します。

- GiftSuperchat: Youtube でのスパチャ、Twitch でのビッツ、ツイキャスのお茶爆など、ギフトが送られた際にコメントを発信します
- WelcomeSyoken: 初めてコメントする方への挨拶メッセージの表示を制御します。
- WelcomeAgain: 一定期間後に再び視聴した方への挨拶メッセージの表示を制御します。表示する日数は、switch の値で設定します。
- WelcomeHi: その配信枠内で初めてコメントした方への挨拶メッセージの表示を制御します。
- checkCount: キリ番を踏んだ方への特別な対応を行うかどうかを制御します。
- BotTimer: 定期的にわんコメへ自動コメントを行うかどうかを制御します。投稿間隔は分単位で設定します。
- ActivityMgr: 参加者リストに登録された際の反応を制御します。

#### OMIKUJI_SWITCH(機能の ON/OFF)

おみくじ機能に関する設定を行います。

- name: おみくじの名前です。
- modes: 下記のおみくじワードに該当した際に実行される関数を指定します。関数は script フォルダの同名ファイルに定義されています。
- switch: おみくじ機能のオンオフを切り替えます。
- isMember: true の場合、何らかの優遇措置(メンバー・モデレーター・サブスク等)を持つユーザーのみがおみくじに参加できます。
- firstGadget: 初回起動時、ガジェットを表示させます。ガジェットがないおみくじに適用すると不具合が出る可能性があります。
- matchExact: おみくじワードとコメントが完全に一致した場合に適用します。
- matchStartsWith: おみくじワードでコメントがはじまる場合に適用します。
- matchIncludes: おみくじワードがコメントに含まれている場合に適用します。

### 「config-」と付いた設定ファイル

おみくじ関連の関数を定義するファイルです。
#### config-ActivityMgr.js
ユーザーが参加リストに加わった時、または「プレイ中」に Check が入った際にコメントを送信します。
#### config-BotTimer.js
事前に設定された間隔（COMMON_SWITCH で調整可能）で、自動的にコメントを投稿します。
#### config-checkCount.js
ライブ配信中のコメント数が特定の数字（キリ番）に達した時、またはユーザーの累計コメント数が一定数を超えた際に、コメントを投稿します。
#### config-GiftSuperchat.js
YouTube のスーパーチャット、Twitch のビッツ、ツイキャスの投げ銭など、視聴者からギフトを受け取った際に、お礼のコメントを投稿します。
#### config-WelcomeSyoken.js
初見さん(わんコメで過去にコメントを受信したことがないユーザー)に対して、歓迎のコメントを送信します。
#### config-WelcomeAgain.js
前回のコメントから一定期間（デフォルトは 7 日間、COMMON_SWITCH で変更可能）が経過した視聴者に対して、再び歓迎のコメントを送信します。
#### config-WelcomeHi.js
各ライブ配信の最初にコメントを送信してくれた視聴者に対して、歓迎のコメントを送信します。
#### config-WelcomeSagi.js
「初見」や「はじめまして」といったコメントを送信してきた視聴者に対して、過去のコメント履歴に基づいて、初見ではないと判断された場合にコメントを送信します。

#### パラメータ

- weight: 抽選確率に影響を与える数値です。値が大きいほど当選確率が高くなります。
- botKey: CHARACTER の文字列または数値で指定されたキーで、配列内の要素を特定します。
- iconKey: CHARACTER_IMAGE のアイコン画像のキーを指定します。
- message(オプション): わんコメに投稿されるメッセージ。
- party(オプション): WordParty に投稿されるワード。配布されている「word-party_FirstCounter」以外の指定も可能です。
- toast(オプション): 右下にトースト表示されるメッセージ。
- speech(オプション): 音声のみのデータをわんコメに投稿されるメッセージ
- modes(オプション): 指定した関数を起動します。
- criteria(オプション): 総合・個別コメ数の Check や、ギフトなどで使用します。本来であれば、GUI 表示でわかりやすくするのが理想ですが…こんな形で申し訳ないです。

- message、speech で置き換える文字列について。
  以下の文字列は自動的に置換されます：

  1. <\<user>> : ユーザー名
  2. <\<lc>> : 現在の配信枠でのコメント数
  3. <\<tc>> : ユーザーの総コメント数
  4. <\<price>> : ギフト・スパチャの金額

- criteria:
  - type:total/user/gift
    - total:配信枠内でのコメントをカウントし、count の数値に該当するかどうか。
    - user:個人の総コメントをカウントし、count の数値に該当するかどうか。
    - gift:ギフトの金額が、count の数値に該当するかどうか。
  - loop:(total/user)
    - true なら count の倍数でヒットします
    - false なら count 到達後はヒットしません
  - comparison(gift)
    - 1: count 以上
    - 0: count と等しい
    - -1: count 以下

**すべての関数の詳細な使用例については、各設定ファイルを参照してください。**

## おみくじの結果・アナウンスについて

### 設定・音声関連

#### Q. 初見判定ちゃんの声が配信に出ない

A. 【読み上げ】棒読みちゃん連携 ( https://onecomme.com/docs/feature/bouyomichan )
をご参照下さい。

#### Q. コメントが読み上げられるが画面に表示されない

A. コメントを配信画面上に表示するには、別のわんコメジェネレーターを使用する必要があります。お使いの環境に適したジェネレーターを選択し、設定を行ってください。

#### Q. BOT のコメントが、Youtube のコメントに反映されていない

A: 仕様であり、BOT のコメントはわんコメアプリ内でのみ表示されます。YouTube や Twitch のチャットには投稿されません。

#### Q. カスタマイズした設定が反映されない

A: 以下を確認してください：

1. 各設定ファイル を保存したか
2. OBS でシーンをリロードしたか
   設定を反映するには、編集後の保存と OBS シーンのリロードが必要です。

#### Q. カスタマイズしたら反応しない

A: 設定の編集には、Visual Studio Code などのテキストエディタの使用をおすすめします。これらのエディタでは、カッコの閉じ忘れなどを自動的に検出してくれるため、エラーの発生を防ぐことができます。

#### Q. おみくじ結果の読み上げを別のボイス(ずんだもん等)にしたい

![枠IDを取得するには](readme_image/10.png)

1. わんコメの左上にある「追加」ボタンを押し、新しい枠を追加します。
2. 該当する枠の三点リーダー(…)を押し、設定を選択
3. 読み上げボイスをずんだもんなど、お好みのボイスに変更します。
4. 設定した枠を右 Click→ID をコピー
5. USER_CONFIG.js ファイルの CHARACTER 内の frameId に、コピーした ID を貼り付けます。

### おみくじ関連

#### Q. おみくじが反映されない

A: おみくじの結果が表示されない場合は、以下の点をご確認ください。

1. わんコメの起動確認: わんコメアプリが正常に起動しているかご確認ください。
2. わんコメがコメントを正しく拾えているか
3. 設定の確認: USER_CONFIG.js ファイルの「PREFERENCES:基本設定」の「commentValidDuration」の値が適切かご確認ください。この値が短すぎると、コメントへの反応が遅れる場合があります。

#### Q. おみくじをメンバー限定にしたい

A: メンバー限定にするには、USER_CONFIG.js ファイルの「isMember」を true にして下さい。

#### Q. カスタマイズに関する質問全般

A: おみくじの細かいカスタマイズについては、ChatGPT や Claude などの生成 AI が役立つ場合があります。これらの AI に具体的な質問をすることで、より詳細な情報を得ることができます。

#### Q. おみくじの内容は変更しても OK？

A: はい、おみくじの内容は自由に変更していただいて構いません。

#### Q. キャラクターをゆっくり霊夢から変更してもいい？

A: もちろん変更して OK です!

#### Q. ランキングが表示されるが OBS でどう移動するん？

A: OBS でランキングの表示位置を変更するには、「対話(操作)」機能を使用します。ランキングが表示されているソース（FirstCounter）を右クリックし、「対話(操作)」を選択すると、表示位置を調整できるメニューが表示されます。

#### Q. じゃんけんの勝率低すぎない？

A: これでも高い方です。ケイスケ ホンダはもっと強いです。
詳細 : https://dic.pixiv.net/a/%E6%9C%AC%E7%94%B0%E3%81%A8%E3%81%98%E3%82%83%E3%82%93%E3%81%91%E3%82%93

#### Q. Ver0.6 にあったおみくじは？

A: 今後、プラグインという形で配布する予定です。

### トラブルシューティング

#### Q. おみくじの結果が 2 つ表示される

![OBSで音声を制御する、表示されていないときにソースをシャットダウンする にチェック](readme_image/06.png)
A: おみくじの結果が 2 つ表示される場合、別のシーンでも同じスクリプトが実行されている可能性があります。これを防ぐには、以下の設定を行ってください。

- ソースのプロパティを開く: おみくじを表示しているソースを右クリックし、「プロパティ」を選択します。
- プロパティから以下の設定を行います
  - **「OBS で音声を制御する」**にチェックを入れる。
  - **「表示されていないときにソースをシャットダウンする」**にチェックを入れる。

#### Q. おみくじを連続で行うとコメントが反映されなくなる

A: おみくじを短時間に何度も行うと、配信プラットフォームの自動規制（ソフト BAN）により、コメントが反映されなくなることがあります。

#### Q. 複数視聴者の同時コメントで結果が表示されない

A: 「コメントが表示されない」ケースが報告されています。原因は究明中ですが、もしよければ、報告をいただければと思います。

## 備考：コードの改変について

### 改変の自由度

- このコードは、わんコメのテンプレートをベースにしていますが、さらなる改変を歓迎します。
- 必要に応じて自由にカスタマイズしてください。

### 著作権と利用規約

- わんコメの利用規約に基づき、本コードは商業利用を含め自由に利用可能です。
- ただし、おみくじの一部サンプル内容には元ネタがあるため、良識の範囲内でご使用ください。

### コードの再配布について

- 改変していないコードの配布は禁止とします。
- コードを改変した場合のみ、再配布が許可されます。
  - クレジットについては、readme に配布元の URL を貼っていただければ OK です

### サポートとフィードバック

- コードに関する質問や提案がある場合は、[https://twitter.com/pintocuru]にお寄せください。
- 作者はコミュニケーションが苦手なため、返信が遅れたり、場合によっては返信がない可能性があります。ご了承ください。
- 皆様からのフィードバックは歓迎しますが、即時の対応は難しい場合があります。

注意: コードの一部が最適化されていない場合がありますが、ご了承ください。継続的な改善を行っています。

## バージョン情報

#### v0.7.5 24/09/10
- BotMessage機能を強化。表現の幅が増えました。使い方はサンプルを参照下さい。
- 他、内部の細かい修正


#### v0.7.3 24/08/30
- 内部ファイルを少し修正。アップデートする際は、scriptフォルダだけでなく、index.htmlも更新してください。
- readmeを、本体とキャラクター素材で分離しました。


#### v0.7.2 24/08/28

- わんコメのバージョンアップをすると、BOTが表示できなくなる問題を修正(わんコメ6.0.0-beta.40で動作確認)

#### v0.7.1 24/08/28

- 初回起動時、常時ガジェットを表示させる「firstGadget」機能の実装
- 「おみくじ BOT 用 word-party」のリリースによる readme の変更
- 他、内部の細かい修正

#### v0.7.0 24/08/24

- より多くのユーザーが使いやすいように、システム全体を見直し、カスタマイズ性を大幅に改善しました。
- システムの安定性と拡張性を高めるため、ファイル構造を全面的に見直しました。そのため、v0.6 でご利用いただいていた設定は、そのままではご利用いただけません。
- v0.6 はデフォルトで入っているおみくじ機能が多すぎたため、「おみくじ」「じゃんけん」「スロット」「スイカゲーム」の 4 つにしました。
- おみくじ機能が大幅に強化されました。
  - 履歴機能: 過去のおみくじ結果を記録し、いつでも確認できるようになりました。
  - ランキング機能: ユーザー間でのランキングを作成し、競い合うことができます。
- 「おみくじ」「初見判定」「スパチャ」などの通知を、画面上に重ねて表示する「トースト通知」機能を実装しました。これにより、複数の通知が同時に発生した場合でも、全ての情報を把握することができます。
- 複数のユーザーが同時にコメントした場合、重複したコメントに対して「もう一度コメントしてください」と通知する機能を実装しました。

#### v0.61 24/07/28

- 初見判定が複数回判定されるバグ(初見・久しぶりが同時に出てしまう)を修正
- Bot の発言を見やすくしました

#### v0.6 24/07/23

- Bot の設計を見直し、安定性を向上させました
  - 初見詐欺判定がちょっとだけ賢くなりました
- キリ番および個別コメント数に対する反応機能を追加しました
- メンバー限定おみくじの設定が可能になりました
- 参加型配信への反応機能を追加しました
- おみくじ機能に大幅な変更と追加を行いました
  - ガチャ風おみくじ「幻獣 3 連おみくじ」の追加
  - 「ボンバースロット」の追加。
  - スプラトゥーン 3 の「二つ名」を追加。
  - ポケモンの「ゆびをふる」を追加。
  - 桃太郎電鉄の「カード」を追加。
  - 95%でひみつ道具を出してくれる「ドラちゃん」を追加。
- 他、細かい不具合の修正

開発者からのお詫びと説明

- ジェネレーターの開発を試みましたが、技術的な制約により実現できませんでした。
  - アプリを作るのは難しいです…
- 今後も、コードベースでの提供となります。これにより、カスタマイズの難易度が上がってしまうことをお詫び申し上げます。

#### v0.3-v0.5

- 作成者が個人で使用していたもので、非公開です。

#### v0.23 24/02/23

- 【重要】v0.22 以前では「フキダシが表示されない」という致命的なバグがありました。これを修正しました。お手数をかけてしまい申し訳ありません。

#### v0.22 24/02/22

- 初見判定ちゃんがコメントした時、わんコメの他のテンプレートでアイコンを表示するように
- ギフトコメントが来ても反応しないバグを修正
- 導入方法で、音声について重要な事を書き忘れていたので追記
- 参加型管理のリスト入りの際「挑戦者が現れました」の WordParty を追加
- 他、細かい不具合の修正

#### v0.21 24/02/22

- わんコメのコメントテスターで「おみくじ」や「じゃんけん」が起動しない不具合を修正
- Nightbot 以外の Bot や、特定のユーザーのコメントも表示できるように
- じゃんけんの文章を少し変更。マリサ キリサメの心なんて読めるわけがない、そう思ってないですか
- 他、細かい不具合の修正

#### v0.2 : 24/02/21 0.1 から大幅な仕様変更

- キャラクターによって、名前の色やコメント色を変えられるように
- 遅延機能の追加により、メッセージ、WordParty を複数投稿可能に
- おみくじ機能の追加
- ギフト・スパチャ対応機能の追加
- 参加型管理で反応する機能を追加
- 細かいバグ修正等

#### v0.1 : 24/02/02

- 初版

---

せすじピンとしてます @pintocuru
https://twitter.com/pintocuru
https://www.youtube.com/@pintocuru
