<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>おみくじルールエディタ</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.3/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.3/dist/vuetify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
  <div id="app">
    <v-app>
      <v-container fluid>
        <v-row>
          <v-col cols="3">
            <v-card>
              <v-card-title>ナビゲーション</v-card-title>
              <v-card-text>
                <v-list dense>
                  <v-subheader>ルール</v-subheader>
                  <v-list-item v-for="(rule, index) in state.rules" :key="'rule-' + index"
                    :class="{ 'v-list-item--active': isSelected('rule', index) }" @click="selectItem('rule', index)">
                    <v-list-item-title>{{ rule.name || 'Unnamed Rule ' + (index + 1) }}</v-list-item-title>
                  </v-list-item>
                  <v-list-item @click="addRule">
                    <v-list-item-title>
                      <v-icon>mdi-plus</v-icon> 新しいルールを追加
                    </v-list-item-title>
                  </v-list-item>
    
                  <v-divider></v-divider>
    
                  <v-subheader>おみくじ</v-subheader>
                  <v-list-item v-for="(omikuji, index) in state.omikuji" :key="'omikuji-' + index"
                    :class="{ 'v-list-item--active': isSelected('omikuji', index) }" @click="selectItem('omikuji', index)">
                    <v-list-item-title>おみくじ {{ index + 1 }}</v-list-item-title>
                  </v-list-item>
                  <v-list-item @click="addOmikuji">
                    <v-list-item-title>
                      <v-icon>mdi-plus</v-icon> 新しいおみくじを追加
                    </v-list-item-title>
                  </v-list-item>
                </v-list>
              </v-card-text>
            </v-card>
          </v-col>
    
          <v-col cols="9">
            <v-card>
              <v-card-title>おみくじエディタ</v-card-title>
              <v-card-text>
                <v-progress-linear v-if="loading" indeterminate color="primary"></v-progress-linear>
                <v-tabs v-model="tab">
                  <v-tab>ルール</v-tab>
                  <v-tab>おみくじ</v-tab>
                </v-tabs>
    
                <v-tabs-items v-model="tab">
                  <v-tab-item>
                    <v-list v-if="selectedItem && selectedItem.type === 'rule'">
                      <v-list-item>
                        <v-row>
                          <v-col cols="12" sm="6" md="4">
                            <v-text-field v-model="state.rules[selectedItem.index].name" label="おみくじ名"></v-text-field>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-text-field v-model.number="state.rules[selectedItem.index].modes" label="モード"
                              type="number"></v-text-field>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-switch v-model="state.rules[selectedItem.index].switch" label="有効/無効"></v-switch>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-switch v-model="state.rules[selectedItem.index].isModerator" label="モデレーターのみ"></v-switch>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-switch v-model="state.rules[selectedItem.index].isMember" label="メンバーのみ"></v-switch>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.rules[selectedItem.index].matchExact" label="完全一致" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.rules[selectedItem.index].matchStartsWith" label="前方一致" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.rules[selectedItem.index].matchIncludes" label="部分一致" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-btn color="error" @click="deleteRule(selectedItem.index)">削除</v-btn>
                          </v-col>
                        </v-row>
                      </v-list-item>
                    </v-list>
                    <v-alert v-else type="info">左側のリストからルールを選択してください。</v-alert>
                  </v-tab-item>
    
                  <v-tab-item>
                    <v-list v-if="selectedItem && selectedItem.type === 'omikuji'">
                      <v-list-item>
                        <v-row>
                          <v-col cols="12" sm="6" md="4">
                            <v-text-field v-model.number="state.omikuji[selectedItem.index].weight" label="出現比"
                              type="number"></v-text-field>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-text-field v-model.number="state.omikuji[selectedItem.index].botKey" label="キャラクターキー"
                              type="number"></v-text-field>
                          </v-col>
                          <v-col cols="12" sm="6" md="4">
                            <v-text-field v-model="state.omikuji[selectedItem.index].iconKey" label="アイコンキー"></v-text-field>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.omikuji[selectedItem.index].party" label="WordParty" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.omikuji[selectedItem.index].message" label="メッセージ" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.omikuji[selectedItem.index].random" label="ランダムメッセージ" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.omikuji[selectedItem.index].toast" label="トースト" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-combobox v-model="state.omikuji[selectedItem.index].speech" label="スピーチ" multiple
                              chips></v-combobox>
                          </v-col>
                          <v-col cols="12">
                            <v-btn color="error" @click="deleteOmikuji(selectedItem.index)">削除</v-btn>
                          </v-col>
                        </v-row>
                      </v-list-item>
                    </v-list>
                    <v-alert v-else type="info">左側のリストからおみくじを選択してください。</v-alert>
                  </v-tab-item>
                </v-tabs-items>
              </v-card-text>
              <v-card-actions>
                <v-btn color="success" @click="saveData">保存</v-btn>
                <v-spacer></v-spacer>
                <v-snackbar v-model="!!saveStatus" :timeout="3000">
                  {{ saveStatus }}
                </v-snackbar>
              </v-card-actions>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
    </v-app>
  </div>


  <script>
   const { createApp, ref, reactive, onMounted, computed } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify();

    const app = createApp({
      setup() {
        const tab = ref(null);
        const state = reactive({
          rules: [],
          omikuji: []
        });
        const loading = ref(true);
        const saveStatus = ref('');
        const selectedItem = ref(null);

        // データをフェッチする関数
        const fetchData = async () => {
          try {
            loading.value = true;
            const data = await fetchStateData();
            updateState(data);
          } catch (error) {
            handleFetchError(error);
          } finally {
            loading.value = false;
          }
        };

        // APIからデータを取得する関数
        const fetchStateData = async () => {
          const response = await fetch('/api/state.json');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return await response.json();
        };

        // 状態を更新する関数
        const updateState = (data) => {
          Object.assign(state, data);
        };

        // フェッチエラーを処理する関数
        const handleFetchError = (error) => {
          console.error('Error fetching data:', error);
          // ここでユーザーへのエラー表示などを行うことができます
        };

        // データを保存する関数
        const saveData = async () => {
          try {
            saveStatus.value = 'Saving...';
            await postStateData(state);
            saveStatus.value = 'Saved successfully!';
          } catch (error) {
            handleSaveError(error);
          }
        };

        // APIにデータを送信する関数
        const postStateData = async (data) => {
          const response = await fetch('/api/state.json', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
        };

        // 保存エラーを処理する関数
        const handleSaveError = (error) => {
          console.error('Error saving data:', error);
          saveStatus.value = 'Error saving data';
          // ここでユーザーへのエラー表示などを行うことができます
        };

        // 新しいルールを作成する関数
        const createNewRule = () => ({
          name: "",
          modes: 0,
          switch: true,
          isModerator: false,
          isMember: false,
          matchExact: [],
          matchStartsWith: [],
          matchIncludes: [],
        });

        // 新しいルールを追加する関数
        const addRule = () => {
          const newRule = createNewRule();
          state.rules.push(newRule);
          selectItem('rule', state.rules.length - 1);
        };

        // 新しいおみくじを作成する関数
        const createNewOmikuji = () => ({
          weight: 0,
          botKey: 0,
          iconKey: "",
          party: [],
          message: [],
          random: [],
          toast: [],
          speech: [],
        });

        // 新しいおみくじを追加する関数
        const addOmikuji = () => {
          const newOmikuji = createNewOmikuji();
          state.omikuji.push(newOmikuji);
          selectItem('omikuji', state.omikuji.length - 1);
        };

        // アイテムを削除する関数
        const deleteItem = (type, index) => {
          state[type + 's'].splice(index, 1);
          if (isItemSelected(type, index)) {
            selectedItem.value = null;
          }
        };

        // ルールを削除する関数
        const deleteRule = (index) => deleteItem('rule', index);

        // おみくじを削除する関数
        const deleteOmikuji = (index) => deleteItem('omikuji', index);

        // アイテムを選択する関数
        const selectItem = (type, index) => {
          selectedItem.value = { type, index };
          tab.value = type === 'rule' ? 0 : 1;
        };

        // アイテムが選択されているかどうかを確認する関数
        const isItemSelected = (type, index) =>
          selectedItem.value && selectedItem.value.type === type && selectedItem.value.index === index;

        // アイテムが選択されているかどうかを確認する計算プロパティ
        const isSelected = computed(() => isItemSelected);

        onMounted(() => {
          fetchData();
        });

        return {
          tab,
          state,
          loading,
          saveStatus,
          selectedItem,
          fetchData,
          saveData,
          addRule,
          addOmikuji,
          deleteRule,
          deleteOmikuji,
          selectItem,
          isSelected
        };
      },
    });

    app.use(vuetify).mount('#app');
  </script>
</body>

</html>